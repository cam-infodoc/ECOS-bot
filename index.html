<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>BotECOS</title>
<style>
body {
  font-family: system-ui;
  background: #f0f0f0;
  display: flex;
  justify-content: center;
  padding: 20px;
}

.chat-container {
  background: white;
  width: 360px;
  height: 600px;
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.messages {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

/* ===== BOT AVEC AVATAR ===== */
.bot-container {
  display: flex;
  align-items: flex-start;
  gap: 8px;
}

.bot-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #fff;
  border: 1px solid #ccc;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  flex-shrink: 0;
}

.bot {
  background: #E5E5EA;
  padding: 10px 14px;
  border-radius: 18px 18px 18px 4px;
  max-width: 75%;
  white-space: pre-wrap;
}

/* ===== USER ===== */
.user {
  align-self: flex-end;
  background: #0084FF;
  color: white;
  padding: 10px 14px;
  border-radius: 18px 18px 4px 18px;
  max-width: 75%;
}

.input-area {
  display: flex;
  border-top: 1px solid #ddd;
}

input {
  flex: 1;
  border: none;
  padding: 12px;
  font-size: 14px;
}

button {
  border: none;
  padding: 12px;
  background: #0084FF;
  color: white;
  cursor: pointer;
}

#finishBtn {
  background: #ff5c7b;
  margin-left: 4px;
}

/* ===== CHOICES ===== */
.choices {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 10px;
}

.choices button {
  width: calc(50% - 4px);
  padding: 12px;
  background: #0084FF;
  color: white;
  font-weight: bold;
  border-radius: 12px;
  border: none;
  cursor: pointer;
}
</style>
</head>
<body>

<div class="chat-container">
  <div class="messages" id="messages"></div>
  <div class="input-area">
    <input id="input" placeholder="√âcris ta question‚Ä¶">
    <button onclick="send()">‚û§</button>
    <button id="finishBtn" onclick="calculateScore()" disabled>üèÅ Terminer</button>
  </div>
</div>

<script>
// ===== DATA =====
const data = {
  themes: [
    {
      id: "HGE",
      title: "H√©pato-gastro-ent√©rologie",
      chapters: [
        {
          id: "SDD1",
          title: "Constipation",
          intro: "Vous √™tes gastro-ent√©rologue et vous recevez Mme Dubois, 31 ans, pour une constipation chronique.",
          recap: "Constipation chronique fonctionnelle sans signe de gravit√©. Il fallait √©liminer les drapeaux rouges, rassurer la patiente et proposer des mesures hygi√©no-di√©t√©tiques en premi√®re intention.",
          questionSet: [
            { id:"q1", patterns:["√©volution","combien de temps"], answer:"Je suis constip√©e depuis environ 4 ans." },
            { id:"q2", patterns:["amaigrissement","perte de poids"], answer:"Non, je n'ai pas perdu de poids." },
            { id:"q3", patterns:["sang","rectorragie"], answer:"Non, je n'ai jamais vu de sang dans mes selles." },
            { id:"q4", patterns:["douleur","nuit"], answer:"√áa ne me r√©veille pas la nuit, ce sont plut√¥t des spasmes." },
            { id:"q5", patterns:["laxatif","traitement"], answer:"Si √ßa peut m'aider, je veux bien essayer." }
          ]
        }
      ]
    }
  ],
  botBehavior: { fallbackAnswer: "Je ne sais pas." }
};

// ===== VARIABLES =====
let currentChapter = null;
let questionsAsked = new Set();
const messages = document.getElementById("messages");
const input = document.getElementById("input");
const finishBtn = document.getElementById("finishBtn");

// ===== UTILS =====
function normalizeText(text){
  return text.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();
}

/* ===== BOT TYPING EFFECT ===== */
function botSay(text){
  const container = document.createElement("div");
  container.className = "bot-container";

  const avatar = document.createElement("div");
  avatar.className = "bot-avatar";
  avatar.textContent = "ü§ñ";

  const bubble = document.createElement("div");
  bubble.className = "bot";
  bubble.textContent = "";

  container.appendChild(avatar);
  container.appendChild(bubble);
  messages.appendChild(container);
  messages.scrollTop = messages.scrollHeight;

  let i = 0;
  const speed = 20; // ‚Üì plus petit = plus rapide

  const interval = setInterval(() => {
    bubble.textContent += text.charAt(i);
    i++;
    messages.scrollTop = messages.scrollHeight;
    if (i >= text.length) clearInterval(interval);
  }, speed);
}

function userSay(text){
  const div = document.createElement("div");
  div.className = "user";
  div.textContent = text;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

// ===== THEMES =====
function showThemes(){
  botSay("Bienvenue üëã Choisis une sp√©cialit√© :");
  const wrapper = document.createElement("div");
  wrapper.className = "choices";

  data.themes.forEach(theme=>{
    const btn = document.createElement("button");
    btn.textContent = theme.title;
    btn.onclick = () => selectTheme(theme);
    wrapper.appendChild(btn);
  });

  messages.appendChild(wrapper);
}

function selectTheme(theme){
  document.querySelectorAll(".choices").forEach(e=>e.remove());
  currentChapter = theme.chapters[0];
  questionsAsked.clear();
  botSay(`üìò ${currentChapter.title}`);
  botSay(currentChapter.intro);
  finishBtn.disabled = false;
}

// ===== CHAT =====
function send(){
  if(!currentChapter) return;
  let text = input.value.trim();
  if(!text) return;

  userSay(text);
  input.value = "";

  const normalized = normalizeText(text);
  let matched = false;

  currentChapter.questionSet.forEach(q=>{
    q.patterns.forEach(p=>{
      if(normalized.includes(normalizeText(p))){
        botSay(q.answer);
        questionsAsked.add(q.id);
        matched = true;
      }
    });
  });

  if(!matched) botSay(data.botBehavior.fallbackAnswer);
}

// ===== FIN =====
function calculateScore(){
  if(!currentChapter) return;

  botSay("üìä Fin de la consultation");
  botSay(`Questions abord√©es : ${questionsAsked.size} / ${currentChapter.questionSet.length}`);
  botSay("üìù R√©capitulatif :");
  botSay(currentChapter.recap);

  currentChapter = null;
  questionsAsked.clear();
  finishBtn.disabled = true;
  showThemes();
}

// ===== START =====
showThemes();
</script>

</body>
</html>
