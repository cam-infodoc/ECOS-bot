<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>BotECOS</title>
<style>
body { font-family: system-ui; background: #f0f0f0; display: flex; justify-content: center; padding: 20px; }
.chat-container { background: white; width: 360px; height: 600px; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; }
.messages { flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
.bot { align-self: flex-start; background: #E5E5EA; padding: 10px 14px; border-radius: 18px 18px 18px 4px; max-width: 75%; }
.user { align-self: flex-end; background: #0084FF; color: white; padding: 10px 14px; border-radius: 18px 18px 4px 18px; max-width: 75%; }
.input-area { display: flex; border-top: 1px solid #ddd; }
input { flex: 1; border: none; padding: 12px; font-size: 14px; }
button { border: none; padding: 12px; background: #0084FF; color: white; cursor: pointer; }
#finishBtn { background: #FF5722; margin-left: 4px; }
.choices button { margin-top: 6px; width: 100%; border-radius: 12px; padding: 10px; background: #0084FF; color: white; font-weight: bold; border: none; cursor: pointer; transition: background 0.2s; }
.choices button:hover { background: #005bb5; }
</style>
</head>
<body>

<div class="chat-container">
  <div class="messages" id="messages"></div>
  <div class="input-area">
    <input id="input" placeholder="√âcris ta question‚Ä¶">
    <button onclick="send()">‚û§</button>
    <button id="finishBtn" onclick="calculateScore()">üèÅ Terminer</button>
  </div>
</div>

<script>
// ===== JSON int√©gr√© =====
const data = {
  "app": { "name": "BotECOS" },
  "themes": [
    {
      "id": "science",
      "title": "Science",
      "chapters": [
        {
          "id": "physique",
          "title": "Physique",
          "intro": "La physique √©tudie les lois fondamentales de l‚Äôunivers.",
          "questionSet": [
            { "id": "q_phys_1", "patterns":["qu'est-ce que la physique","c'est quoi la physique","d√©finition physique"], "answer":"La physique est la science qui √©tudie la mati√®re, l‚Äô√©nergie et leurs interactions." },
            { "id": "q_phys_2", "patterns":["qu'est-ce que la gravit√©","c'est quoi la gravit√©","d√©finition gravit√©"], "answer":"La gravit√© est une force d‚Äôattraction entre les corps." }
          ]
        },
        {
          "id": "biologie",
          "title": "Biologie",
          "intro": "La biologie est la science du vivant.",
          "questionSet": [
            { "id": "q_bio_1", "patterns":["qu'est-ce que la biologie","c'est quoi la biologie","d√©finition biologie"], "answer":"La biologie √©tudie les √™tres vivants." }
          ]
        }
      ]
    },
    {
      "id": "histoire",
      "title": "Histoire",
      "chapters": [
        {
          "id": "antiquite",
          "title": "Antiquit√©",
          "intro": "L‚ÄôAntiquit√© est une p√©riode historique ancienne.",
          "questionSet": [
            { "id": "q_ant_1", "patterns":["qu'est-ce que l'antiquit√©","c'est quoi l'antiquit√©"], "answer":"L‚ÄôAntiquit√© commence avec l‚Äô√©criture et se termine avec la chute de Rome." }
          ]
        }
      ]
    }
  ],
  "botBehavior": { "fallbackAnswer":"Je ne sais pas." }
};

// ===== Variables de session =====
let currentChapter;
let questionsAsked = new Set();
const messages = document.getElementById("messages");
const input = document.getElementById("input");
const finishBtn = document.getElementById("finishBtn");

// ===== Utilitaires =====
function normalizeText(text){ return text.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase(); }
function botSay(text){ const div=document.createElement("div"); div.className="bot"; div.textContent=text; messages.appendChild(div); messages.scrollTop=messages.scrollHeight; }
function userSay(text){ const div=document.createElement("div"); div.className="user"; div.textContent=text; messages.appendChild(div); messages.scrollTop=messages.scrollHeight; }

// ===== Th√®mes =====
function showThemes(){
  botSay("Bienvenue üëã Choisis un th√®me :");
  data.themes.forEach(theme=>{
    const btn=document.createElement("button");
    btn.textContent=theme.title;
    btn.onclick=()=>selectTheme(theme);
    btn.className="choices";
    messages.appendChild(btn);
  });
}

// ===== S√©lection th√®me et chapitre al√©atoire =====
function selectTheme(theme){
  document.querySelectorAll(".choices").forEach(b=>b.remove());
  const chapter = theme.chapters[Math.floor(Math.random()*theme.chapters.length)];
  currentChapter = chapter;
  questionsAsked.clear();
  botSay(`üìò Cours s√©lectionn√© : ${chapter.title}`);
  botSay(chapter.intro);
  finishBtn.disabled = false;
}

// ===== Envoi d‚Äôune question =====
function send(){
  let text = input.value.trim();
  if(!text || !currentChapter) return;
  userSay(text);
  input.value = "";
  text = normalizeText(text);

  let matched=false;
  currentChapter.questionSet.forEach(q=>{
    q.patterns.forEach(p=>{
      const pattern = normalizeText(p);
      if(text.includes(pattern)){
        botSay(q.answer);
        questionsAsked.add(q.id);
        matched=true;
      }
    });
  });

  if(!matched) botSay(data.botBehavior.fallbackAnswer);
}

// ===== Calcul score et correction =====
function calculateScore(){
  if(!currentChapter) return;
  const totalQuestions = currentChapter.questionSet.length;
  const answeredQuestions = questionsAsked.size;

  botSay("üìä Fin du chapitre !");
  botSay(`Tu as r√©pondu correctement √† ${answeredQuestions} sur ${totalQuestions} questions.`);

  const missedQuestions = currentChapter.questionSet.filter(q=>!questionsAsked.has(q.id));
  if(missedQuestions.length>0){
    botSay("üí° Pour avoir 20/20, il fallait poser les questions suivantes :");
    missedQuestions.forEach(q=>botSay("- "+q.patterns[0]));
  } else {
    botSay("üéâ Parfait ! Tu as pos√© toutes les questions du chapitre.");
  }

  currentChapter=null;
  questionsAsked.clear();
  finishBtn.disabled=true;
  showThemes();
}

// ===== D√©marrage =====
showThemes();
</script>

</body>
</html>
