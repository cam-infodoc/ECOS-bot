<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>BotECOS</title>
<style>
body { font-family: system-ui; background: #f0f0f0; display: flex; justify-content: center; padding: 20px; }
.chat-container { background: white; width: 360px; height: 600px; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; }
.messages { flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
.bot { align-self: flex-start; background: #E5E5EA; padding: 10px 14px; border-radius: 18px 18px 18px 4px; max-width: 75%; }
.user { align-self: flex-end; background: #0084FF; color: white; padding: 10px 14px; border-radius: 18px 18px 4px 18px; max-width: 75%; }
.input-area { display: flex; border-top: 1px solid #ddd; }
input { flex: 1; border: none; padding: 12px; font-size: 14px; }
button { border: none; padding: 12px; background: #0084FF; color: white; cursor: pointer; }
#finishBtn { background: #ff5c7b; margin-left: 4px; }

/* === Styles des boutons th√®mes c√¥te √† c√¥te === */
.choices {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 10px;
}
.choices button {
  width: calc(50% - 4px); /* moiti√© largeur - moiti√© gap */
  padding: 12px;
  background: #0084FF;
  color: white;
  font-weight: bold;
  border-radius: 12px;   /* coins arrondis */
  border: none;
  cursor: pointer;
  text-align: center;
  transition: background 0.2s;
}
.choices button:hover {
  background: #005bb5;
}
  /* === Avatar du bot === */
.bot-container {
  display: flex;
  align-items: flex-start;
  gap: 8px;
}
.bot-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  border: 1px solid #ccc;
  font-size: 18px;
}
</style>
</head>
<body>

<div class="chat-container">
  <div class="messages" id="messages"></div>
  <div class="input-area">
    <input id="input" placeholder="√âcris ta question‚Ä¶">
    <button onclick="send()">‚û§</button>
    <button id="finishBtn" onclick="calculateScore()">üèÅ Terminer</button>
  </div>
</div>

<script>
// ===== JSON int√©gr√© =====
const data = {
  "app": { "name": "BotECOS" },
  "themes": [
    {
      "id": "HGE",
      "title": "h√©pato-gastro-ent√©rologie",
      "chapters": [
        {
          "id": "SDD1",
          "title": "Constipation",
          "intro": "Vous √™tes gastro-ent√©rologue et vous recevez Mme Dubois une patiente de 31 ans qui se plaint d'une constipation. Menez un interrogatoire d√©taill√© pour rechercher le mode d'√©volution et le m√©canisme de la constipation. D√©cidez de la prescription d'examen.s compl√©mentaire.s. Expliquez les MHD et d'autom√©dication.",
          "questionSet": [
            { "id": "q_constip_1", "patterns":["√©volution","combien de temps","combien de jours"], "answer":"Je suis constip√©e depuis environ 4 ans, sans aggravation particuli√®re. Et je fais moins de 3 selles par semaine." },
            { "id": "q_constip_2", "patterns":["alt√©ration √©tat g√©n√©ral","amaigrissement","perte de poids", "poids", "plus fatigu√©e"], "answer":"Je n'ai pas perdu de poids et je me sens pas plus fatigu√©e qu'avant Docteur." },
            { "id": "q_constip_3", "patterns":["douleurs nocturnes","douleur la nuit","douleur insomniante", "vous emp√™che de dormir", "nuit", "douleur"], "answer":"Ma douleur abdominale ne m'emp√™che pas de bien dormir la nuit. Je dirais que c'est une douleur comme des spasmes." },
            { "id": "q_constip_4", "patterns":["rectorragies","rectorragie","m√©l√©na", "sang dans les selles", "sang"], "answer":"Oula vous me faites peur Docteur, non non il n'y a pas de sang dans mes selles. On va faire une imagerie du coup Docteur ?" },
            { "id": "q_constip_5", "patterns":["contractions abdominales avant la selle","√©preintes","t√©nesme", "faux besoins", "glaires"], "answer":"Non je n'ai aucun signe de syndrome rectal." },
            { "id": "q_constip_6", "patterns":["dures","petites","moins de selles par semaine", "moins souvent"], "answer":"C'est vrai que je vais moins √† la selle qu'avant, environ 3 fois par semaine. D'ailleurs mes selles sont petites et tr√®s dures Docteur. Je bois beaucoup d'eau et je fais de la corde √† sauter pour m'aider, √ßa marche pas trop..." },
            { "id": "q_constip_7", "patterns":["efforts de pouss√©e","vous devez pousser","incomplet", "reste encore des selles", "manoeuvres digitales", "√©vacuation des selles √† la main"], "answer":"Ah non non je fais caca normalement. Je pousse m√™me moins qu'avant √† vrai dire, mais quand je suis all√©e √† la selle c'est fini." },
            { "id": "q_constip_8", "patterns":["gaz","naus√©es","vomissements", "vomi", "vomis"], "answer":"J'ai toujours des gaz, et non je n'ai jamais vomi ni vraiment eu de naus√©es." },
            { "id": "q_constip_9", "patterns":["examens compl√©mentaires","imagerie","scanner", "radiographie"], "answer":"Je vous fais confiance en terme d'imagerie." },
            { "id": "q_constip_10", "patterns":["fibre","r√®gles hygi√©no-di√©t√©tiques","mesures hygi√©no-di√©t√©tiques"], "answer":"Ok Docteur je ferai ce que vous me pr√©conisez." },
            { "id": "q_constip_11", "patterns":["laxatifs","m√©dicaments","m√©dicament", "laxatifs osmotiques", "laxatifs de lest"], "answer":"D'accord Docteur si √ßa peut m'aider je vous √©coute !" },
          ]
        },
    }
  ],
  "botBehavior": { "fallbackAnswer":"Je ne sais pas." }
};

// ===== Variables de session =====
let currentChapter;
let questionsAsked = new Set();
const messages = document.getElementById("messages");
const input = document.getElementById("input");
const finishBtn = document.getElementById("finishBtn");

// ===== Utilitaires =====
function normalizeText(text){ return text.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase(); }
function botSay(text){ const div=document.createElement("div"); div.className="bot"; div.textContent=text; messages.appendChild(div); messages.scrollTop=messages.scrollHeight; }
function userSay(text){ const div=document.createElement("div"); div.className="user"; div.textContent=text; messages.appendChild(div); messages.scrollTop=messages.scrollHeight; }

// ===== Th√®mes =====
function showThemes(){
  botSay("Bienvenue üëã Choisis une sp√©cialit√© sur laquelle tu veux t'entrainer :");
  const wrapper = document.createElement("div");
  wrapper.className = "choices";
  data.themes.forEach(theme=>{
    const btn = document.createElement("button");
    btn.textContent = theme.title;
    btn.onclick = () => selectTheme(theme);
    wrapper.appendChild(btn);
  });
  // Ajouter le wrapper dans un div pour que le flex fonctionne
  const msgDiv = document.createElement("div");
  msgDiv.appendChild(wrapper);
  messages.appendChild(msgDiv);
}

// ===== S√©lection th√®me et chapitre al√©atoire =====
function selectTheme(theme){
  document.querySelectorAll(".choices").forEach(b=>b.remove());
  const chapter = theme.chapters[Math.floor(Math.random()*theme.chapters.length)];
  currentChapter = chapter;
  questionsAsked.clear();
  botSay(`üìò Cours s√©lectionn√© : ${chapter.title}`);
  botSay(chapter.intro);
  finishBtn.disabled = false;
}

// ===== Envoi d‚Äôune question =====
function send(){
  let text = input.value.trim();
  if(!text || !currentChapter) return;
  userSay(text);
  input.value = "";
  text = normalizeText(text);

  let matched=false;
  currentChapter.questionSet.forEach(q=>{
    q.patterns.forEach(p=>{
      const pattern = normalizeText(p);
      if(text.includes(pattern)){
        botSay(q.answer);
        questionsAsked.add(q.id);
        matched=true;
      }
    });
  });

  if(!matched) botSay(data.botBehavior.fallbackAnswer);
}

// ===== Calcul score et correction =====
function calculateScore(){
  if(!currentChapter) return;
  const totalQuestions = currentChapter.questionSet.length;
  const answeredQuestions = questionsAsked.size;

  botSay("üìä Fin du chapitre !");
  botSay(`Tu as r√©pondu correctement √† ${answeredQuestions} sur ${totalQuestions} questions.`);

  const missedQuestions = currentChapter.questionSet.filter(q=>!questionsAsked.has(q.id));
  if(missedQuestions.length>0){
    botSay("üí° Pour avoir 20/20, il fallait poser les questions suivantes :");
    missedQuestions.forEach(q=>botSay("- "+q.patterns[0]));
  } else {
    botSay("üéâ Parfait ! Tu as pos√© toutes les questions n√©cessaires. Tu as donc 20/20 !");
  }

  currentChapter=null;
  questionsAsked.clear();
  finishBtn.disabled=true;
  showThemes();
}

// ===== D√©marrage =====
showThemes();
</script>

</body>
</html>
