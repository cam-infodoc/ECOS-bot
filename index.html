<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>BotECOS</title>
<style>
body {
  font-family: system-ui;
  background: #f0f0f0;
  display: flex;
  justify-content: center;
  padding: 20px;
}

.chat-container {
  background: white;
  width: 360px;
  height: 600px;
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.messages {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

/* ===== BOT AVEC AVATAR ===== */
.bot-container {
  display: flex;
  align-items: flex-start;
  gap: 8px;
}

.bot-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #fff;
  border: 1px solid #ccc;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  flex-shrink: 0;
}

.bot {
  background: #E5E5EA;
  padding: 10px 14px;
  border-radius: 18px 18px 18px 4px;
  max-width: 75%;
  white-space: pre-wrap;
}

.thinking {
  font-style: italic;
  opacity: 0.7;
}

/* ===== USER ===== */
.user {
  align-self: flex-end;
  background: #0084FF;
  color: white;
  padding: 10px 14px;
  border-radius: 18px 18px 4px 18px;
  max-width: 75%;
}

.input-area {
  display: flex;
  border-top: 1px solid #ddd;
}

input {
  flex: 1;
  border: none;
  padding: 12px;
  font-size: 14px;
}

button {
  border: none;
  padding: 12px;
  background: #0084FF;
  color: white;
  cursor: pointer;
}

#finishBtn {
  background: #ff5c7b;
  margin-left: 4px;
}

/* ===== CHOICES ===== */
.choices {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 10px;
}

.choices button {
  width: calc(50% - 4px);
  padding: 12px;
  background: #0084FF;
  color: white;
  font-weight: bold;
  border-radius: 12px;
  border: none;
  cursor: pointer;
}
</style>
</head>
<body>

<div class="chat-container">
  <div class="messages" id="messages"></div>
  <div class="input-area">
    <input id="input" placeholder="√âcris ta question‚Ä¶">
    <button onclick="send()">‚û§</button>
    <button id="finishBtn" onclick="calculateScore()" disabled>üèÅ Terminer</button>
  </div>
</div>

<script>
// ===== DATA =====
const data = {
  themes: [
    {
      id: "HGE",
      title: "H√©pato-gastro-ent√©rologie",
      chapters: [
        {
          id: "SDD1",
          title: "Constipation",
          intro: "Vous √™tes gastro-ent√©rologue et vous recevez Mme Dubois, 31 ans, pour une constipation chronique.",
          recap: [
            "Il faut bien diff√©rencier constipation fonctionnelle et organique.",
            "La constipation fonctionnelle ou idiopathique est soit de transit (r√©duction de la fr√©quence ou de l'amplitude des contractions coliques) soit distale (=dysch√©sie, expliqu√©e par un trouble fonctionnel ou anatomique de la statique pelvienne).",
            "La constipation fonctionnelle donne des petites selles dures et peu nombreuses dans la semaine, il faut d'ailleurs chercher une colopathie fonctionnelle.",
            "La constipation distale donne des efforts de pouss√©es importants avec une sensation d'√©vacuation incompl√®te et souvent des manoeuvres distales pour favoriser l'√©vacuation.",
            "Les signes d'alarmes auraient √©t√© une AEG, un amaigrissement, des douleurs nocturnes ou insomniantes, des rectorragies / m√©l√©na ou un syndrome rectal (√©preinte, t√©nesme, faux besoins). Face √† ces signes d'alarme on pense √† une constipation organique ou secondaire et il faut √©liminer le syndrome occlusif.",
            "Pour les examens compl√©mentaires, aucun n'est n√©cessaire chez un constip√© chronique sans signe d'alarme. Un bilan sanguin est possible mais pas obligatoire (NFS, CRP, TSH, ionogramme sanguin, calc√©mie, glyc√©mie, cr√©at).",
            "Si les sympt√¥mes apparaissent apr√®s 50 ans on pense forc√©ment √† prescrire une coloscopie."
          ],

          questionSet: [
            { "id": "q_constip_1", "patterns":["√©volution","combien de temps","combien de jours"], "answer":"Je suis constip√©e depuis environ 4 ans, sans aggravation particuli√®re. Et je fais moins de 3 selles par semaine." },
            { "id": "q_constip_2", "patterns":["alt√©ration √©tat g√©n√©ral","amaigrissement","perte de poids", "poids", "plus fatigu√©e"], "answer":"Je n'ai pas perdu de poids et je me sens pas plus fatigu√©e qu'avant Docteur." },
            { "id": "q_constip_3", "patterns":["douleurs nocturnes","douleur la nuit","douleur insomniante", "vous emp√™che de dormir", "nuit", "douleur"], "answer":"Ma douleur abdominale ne m'emp√™che pas de bien dormir la nuit. Je dirais que c'est une douleur comme des spasmes." },
            { "id": "q_constip_4", "patterns":["rectorragies","rectorragie","m√©l√©na", "sang dans les selles", "sang"], "answer":"Oula vous me faites peur Docteur, non non il n'y a pas de sang dans mes selles. On va faire une imagerie du coup Docteur ?" },
            { "id": "q_constip_5", "patterns":["contractions abdominales avant la selle","√©preintes","t√©nesme", "faux besoins", "glaires"], "answer":"Non je n'ai aucun signe de syndrome rectal." },
            { "id": "q_constip_6", "patterns":["comment sont vos selles", "dures","petites","moins de selles par semaine", "moins souvent"], "answer":"C'est vrai que je vais moins √† la selle qu'avant, environ 3 fois par semaine. D'ailleurs mes selles sont petites et tr√®s dures Docteur. Je bois beaucoup d'eau et je fais de la corde √† sauter pour m'aider, √ßa marche pas trop..." },
            { "id": "q_constip_7", "patterns":["efforts de pouss√©e","vous devez pousser","incomplet", "reste encore des selles", "manoeuvres digitales", "√©vacuation des selles √† la main"], "answer":"Ah non non je fais caca normalement. Je pousse m√™me moins qu'avant √† vrai dire, mais quand je suis all√©e √† la selle c'est fini." },
            { "id": "q_constip_8", "patterns":["gaz","naus√©es","vomissements", "vomi", "vomis"], "answer":"J'ai toujours des gaz, et non je n'ai jamais vomi ni vraiment eu de naus√©es." },
            { "id": "q_constip_9", "patterns":["examens compl√©mentaires","imagerie","scanner", "radiographie"], "answer":"Je vous fais confiance en terme d'imagerie." },
            { "id": "q_constip_10", "patterns":["fibre","r√®gles hygi√©no-di√©t√©tiques","mesures hygi√©no-di√©t√©tiques"], "answer":"Ok Docteur je ferai ce que vous me pr√©conisez." },
            { "id": "q_constip_11", "patterns":["laxatifs","m√©dicaments","m√©dicament", "laxatifs osmotiques", "laxatifs de lest"], "answer":"D'accord Docteur si √ßa peut m'aider je vous √©coute !" },
            { "id": "q_constip_12", "patterns":["ant√©c√©dents m√©dicaux","ant√©c√©dents", "ant√©c√©dents personnels"], "answer":"J'ai eu 2 grossesses avec accouchement par voie basse, la derni√®re il y a un an, et j'ai √©t√© op√©r√©e de l'appendicite." },
            { "id": "q_constip_13", "patterns":["ant√©c√©dents familiaux","famille"], "answer":"Dans ma famille je sais juste que ma tante a eu un cancer de l'ovaire, c'est tout." },
            { "id": "q_constip_14", "patterns":["bonjour"], "answer":"Bonjour, je suis bien Madame Dubois, je vous consulte Docteur car je suis constip√©e." },
            { "id": "q_constip_15", "patterns":["compris", "clair", "autres questions", "questions"], "answer":"Tout est clair pour moi Docteur, merci pour tout bonne journ√©e." },
          ]
        },
        {
          id: "SDD2",
          title: "Diarrh√©e",
          intro: "Vous √™tes gastro-ent√©rologue et vous recevez Mr ROUX, 60 ans, qui se plaint d'une diarrh√©e depuis 4 jours. Cherchez √† l'interrogatoire et √† l'examen clinique les signes orientant le diagnostic √©tiologique. Recherchez les complications de la diarrh√©e.",
          recap: [
            "Il faut savoir identifier le syndrome chol√©riforme et les syndromes invasifs.",
            "Un syndrome chol√©riforme est un trouble de la fonction s√©cr√©toire. Il donne des diarrh√©es profuses af√©cales, on retrouve des signes de d√©shydratation et il n'y a pas de fi√®vre.",
            "Les syndromes invasifs comprennent le syndrome dysent√©rique et le syndrome gastro-ent√©rique.",
            "Le syndrome dysent√©rique signe l'invasion des cellules √©pith√©liales. Il donne du sang, des glaires voire du pus et un syndrome rectal est fr√©quent. Les douleurs abdominales sont diffuses ou colique et on retrouve de la fi√®vre.",
            "Le syndrome gastro-ent√©rique est bact√©rien. Il donne une diarrh√©e asp√©cifique souvent avec naus√©es, vomissement, fi√®vre et syndrome pseudo-grippal."
          ],

          questionSet: [
            { "id": "q_dia_1", "patterns":["ant√©c√©dents","ant√©c√©dents personnels"], "answer":"Je n'ai pas d'ant√©c√©dents particuliers." },
            { "id": "q_dia_2", "patterns":["alcool","tabac","fumez", "buvez", "alcoolo-tabagique"], "answer":"Je ne fume pas, je ne bois pas." },
            { "id": "q_dia_3", "patterns":["voyage","voyag√©","contage", "zone d'end√©mie", "avion"], "answer":"Je n'ai pas voyag√© r√©cemment non. Puis dans ma famille je suis le seul √† √™tre malade." },
            { "id": "q_dia_4", "patterns":["antibiotiques","traitement","traitements"], "answer":"Je n'ai aucun traitement habituellement et r√©cemment je n'ai rien pris de particulier." },
            { "id": "q_dia_5", "patterns":["liquide","sang","glaires", "selles", "d√©crivez moi vos selles"], "answer":"Depuis 4 jours j'ai des diarrh√©es, parfois je trouve m√™me du sang voir des glaires." },
            { "id": "q_dia_6", "patterns":["faux besoins", "tension anale","douleur avant les selles","spasmes", "√©preintes"], "answer":"J'ai des douleurs √† type de spasmes avant de faire caca maintenant que vous me le demandez c'est vrai !" },
            { "id": "q_dia_7", "patterns":["constipation","douleur","douleurs", "naus√©es", "vomissement", "vomi"], "answer":"J'ai des douleurs √† type de spasmes avant les selles mais c'est tout." },
            { "id": "q_dia_8", "patterns":["constantes","tension","fr√©quence cardiaque", "temp√©rature"], "answer":"Ma tension est √† 120/70 mmHg. Ma FC √† 110 bpm. Ma temp√©rature √† 36,5¬∞C et je n'ai pas pris de doliprane avant de venir." },
            { "id": "q_dia_9", "patterns":["soif","s√©cheresse","muqueuses", "trouble conscience"], "answer":"Mes muqueuses sont s√®ches." },
            { "id": "q_dia_10", "patterns":["pli cutan√©","cernes","tachycardie", "hypotension", "oligurie", "perte de poids", "poids", "veines jugulaires"], "answer":"Mes veines jugulaires sont plates et j'ai perdu 3 kg depuis le d√©but de mes diarrh√©es." },
            { "id": "q_dia_11", "patterns":["fi√®vre","frissons"], "answer":"Je ne crois pas avoir eu de fi√®vre √† la maison, en tout cas je n'ai jamais frisson√©. Actuellement je ne frissonne pas d'ailleurs." },
            { "id": "q_dia_12", "patterns":["allergie","allergies"], "answer":"Je n'ai aucune allergie." },
            { "id": "q_dia_13", "patterns":["toxiques","alcool", "tabac", "fumez"], "answer":"Je ne fume pas, je ne bois pas Docteur !" },
            { "id": "q_dia_14", "patterns":["bonjour"], "answer":"Bonjour, je suis bien Monsieur Roux, je vous consulte Docteur car j'ai des diarrh√©es." },
            { "id": "q_dia_15", "patterns":["compris", "clair", "autres questions", "questions"], "answer":"Tout est clair pour moi Docteur, merci pour tout bonne journ√©e." },
          ]
        },
        {
          id: "SDD3",
          title: "Douleur abdominale",
          intro: "Vous √™tes m√©decin aux urgences et vous recevez √† 14h Mr JEAN, un patient de 60 ans amen√© aux urgences par les SP pour d'importantes douleurs abdominales. A l'interrogatoire vous notez qu'il n'a pour seul ant√©c√©dent qu'une constipation chronique, qu'il a d√©but√© des AINS il y a 2 jours pour des douleurs abdominales situ√©es en bas √† gauche du ventre, que depuis ce matin les douleurs sont plus violentes et diffuses c√¥t√©es √† 8/10 et qu'il n'a pas d'arr√™t des gaz et mati√®res. Vous √™tes accompagn√© de votre infirmier Cl√©ment. Examinez le patient et √©valuez le degr√© d'urgence de la situation. Expliquez la prise en charge dans les prochaines heures √† Mr JEAN.",
          recap: [
            "Pour les ECOS il y a plusieurs pathologies responsables de douleur abdominale √† conna√Ætre.",
            "La colique h√©patique : irradiation √† l'√©paule droite ou interscapulaire. La pancr√©atite aigue : irradiation dorsale. L'appendicite aigue : d√©but en ombilical / √©pigastre puis localisation en FID. L'ulc√®re gastrique : post-prandial tardif. La strangulation : brutal puis localisation diffuse. La colique n√©phr√©tique : irradiation vers les OGE.",
            "Il faut bien diff√©rencier la douleur fonctionnelle et organique.",
            "La douleur fonctionnelle est chronique, survient >= 1 fois par semaine, √† type de spasme, surtout en FI ou hypogastre, matinale ou post-prandiale, absente la nuite, soulag√©e par les gaz et/ou selles, augment√©e par le stress, calm√©e par le repos.",
            "La douleur organique est aigue ou chronique, pr√©sente la nuit. La s√©miologie de la douleur ou signes associ√©s orientent vers une pathologie.",
            "Attention l'intensit√© de la douleur en elle m√™me n'est pas discriminante !".
          ],

          questionSet: [
            { "id": "q_dlabdo_1", "patterns":["marbrures","TRC", "temps de recoloration cutan√©e", "froideur extr√©mit√©s"], "answer":"Pas de marbrures, extr√©mit√©s chaudes, TRC √† 2 secondes." },
            { "id": "q_dlabdo_2", "patterns":["confusion","fr√©quence respiratoire","FR", "tension", "sepsis", "qSOFA", "sofa"], "answer":"C'est not√© !" },
            { "id": "q_dlabdo_3", "patterns":["palpation abdominale","contracture","d√©fense", "hernie"], "answer":"Vous retrouvez une contracture g√©n√©ralis√©e de l'abdomen." },
            { "id": "q_dlabdo_4", "patterns":["inspection","inspection abdominale"], "answer":"Absence de cicatrices au niveau abdominal. Rien √† signaler √† l'inspection." },
            { "id": "q_dlabdo_5", "patterns":["perfusion","perfuser","perfus√©", "solut√© d'hydratation", "cristallo√Ødes"], "answer":"Cl√©ment va donc perfuser Mr JEAN." },
            { "id": "q_dlabdo_6", "patterns":["infection", "colite"], "answer":"Le patient va √™tre inform√© de votre suspicion d'infection abdominale".},
            { "id": "q_dlabdo_7", "patterns":["bilan biologique","bilan","h√©mocultures", "h√©moc"], "answer":"Un bilan sanguin sera pr√©lev√© par Cl√©ment, √©galement il piquera des h√©mocultures." },
            { "id": "q_dlabdo_8", "patterns":["constantes","tension","fr√©quence cardiaque", "temp√©rature", "glasgow"], "answer":"TA √† 95/70mmg, FC √† 110 bpm, sat √† 100% en AA, FR √† 24. Temp√©rature √† 39¬∞C. Score de Glasgow √† 15." },
            { "id": "q_dlabdo_9", "patterns":["scanner","scanner abdominal","scanner AP"], "answer":"Le patient est inform√© qu'il r√©alisera un scanner abdominal." },
            { "id": "q_dlabdo_10", "patterns":["op√©ration","chirurgie","chirurgien"], "answer":"Le patient est inform√© de la possibilit√© d'une chirurgie en urgence apr√®s le bilan diagnostique." },
            { "id": "q_dlabdo_11", "patterns":["anesth√©sie g√©n√©rale","unit√© soins intensifs"], "answer":"Le patient est inform√© qu'il sera op√©r√© sous AG et qu'il sera hospitalis√© en unit√© de soins intensifs." },
            { "id": "q_dlabdo_12", "patterns":["bonjour"], "answer":"Monsieur JEAN vous r√©pond avec un visage crisp√© bonjour." }
          ]
        },
        {
          id: "SDD4",
          title: "Douleur anale",
          intro: "Vous √™tes proctologue et recevez en consultation Mme MOREAU, patiente de 40 ans, qui se plaint de douleurs anales depuis 4 jours. Vous devez mener un interrogatoire afin de caract√©riser la douleur et d'orienter votre diagnostic, r√©aliser un examen proctologique et indiquer votre principale hypoth√®se diagnostique.",
          recap: [
            "Pour les ECOS il faut savoir caract√©riser une douleur, on demande : localisation, intensit√©, type, horaire, irradiation, facteurs aggravants ou am√©liorants, signes associ√©s, √©volution.",
            "La douleur anale apr√®s la selle doit vous √©voquer : crise h√©morro√Ødaire (douleur pendant quelques minutes d√©clench√©e par la selle, +/- saignements, dure quelques jours), fissure anale (douleur quelques minutes apr√®s la selle puis r√©cidive de la douleur des heures apr√®s la selle, +/- saignements, dure des semaines.",
            "La douleur anale avant la selle doit vous √©voquer : f√©calome, cancer du rectum. Les deux par syndrome rectal (t√©nesme, √©preintes, √©missions glairo sanglantes af√©cales).",
            "La douleur anale ind√©pendante de la selle doit vous √©voquer : thrombose h√©morro√Ødaire externe (tum√©faction bleue limit√©e, douleur au toucher et √† la position assise, d√©gressive sur quelques heures √† quelques jours), abc√®s anal (tum√©faction mal limit√©e, douleur au toucher et assise, continue sur quelques heures / jours).".
          ],

          questionSet: [
            { "id": "q_dlanale_1", "patterns":["type de douleur","douleur", "d√©crire votre douleur"], "answer":"La douleur c'est comme des br√ªlures depuis 4 jours." },
            { "id": "q_dlanale_2", "patterns":["intensit√© douleur","retentissement","c√¥ter", "EVA"], "answer":"La douleur est assez forte et me d√©range √©norm√©ment pendant la d√©f√©cation, ensuite elle disparait." },
            { "id": "q_dlanale_3", "patterns":["horaire","matin","journ√©e", "soir"], "answer":"La douleur se limite vraiment au moment des selles. Sinon c'est g√©nant mais √ßa va." },
            { "id": "q_dlanale_4", "patterns":["√©volution","√©volu", "√©volue"], "answer":"C'est la 4e fois que √ßa arrive. Tous apr√®s mon 2e accouchement il y a 3 mois." },
            { "id": "q_dlanale_5", "patterns":["aggravant","aggravants","d√©clenchants", "d√©clenchant"], "answer":"La douleur est d√©clench√©e par les selles et calm√©e imm√©diatement apr√®s." },
            { "id": "q_dlanale_6", "patterns":["suintement", "saignement", "sang"], "answer":"Non il n'y a pas de saignements ni de suintement.".},
            { "id": "q_dlanale_7", "patterns":["constipation","diarrh√©e","diarrh√©es", "transit"], "answer":"J'ai tendance √† √™tre constip√©e de nature c'est vrai √ßa. Mais l√† c'est diff√©rent." },
            { "id": "q_dlanale_8", "patterns":["ant√©c√©dents","ant√©c√©dents gyn√©cologiques","gyn√©co"], "answer":"J'ai eu 2 enfants ! Le dernier il y a trois mois et le premier il y a 3 ans. Tous par voie basse, pas de complications." },
            { "id": "q_dlanale_9", "patterns":["temp√©rature","frissons","fi√®vre"], "answer":"Non j'ai pas eu de fi√®vre associ√©e." },
            { "id": "q_dlanale_10", "patterns":["position","g√©nupectorale","genupectorale"], "answer":"D'accord je vais me mettre en position genupectorale Docteur." },
            { "id": "q_dlanale_11", "patterns":["inspection","prolapsus", "fissure anale"], "answer":"L'inspection anale ne retrouve ni prolapsus, ni fissure anale, ni h√©morro√Ødes externes." },
            { "id": "q_dlanale_12", "patterns":["bonjour"], "answer":"Bonjour Docteur, je suis bien Mme MOREAU. Je viens pour des douleurs anales." },
            { "id": "q_dlanale_13", "patterns":["anuscope", "anuscopie"], "answer":"A l'anuscopie vous retrouvez un prolapsus h√©morro√Ødaire interne." },
            { "id": "q_dlanale_14", "patterns":["diagnostic", "hypoth√®se diagnostique", "crise h√©morro√Ødiaire"], "answer":"Votre diagnostic est retenu." },
          ]
        }
      ]
    }
  ],
  botBehavior: { fallbackAnswer: "Je ne sais pas." }
};

// ===== VARIABLES =====
let currentChapter = null;
let questionsAsked = new Set();
let botQueue = [];
let botIsTyping = false;

const messages = document.getElementById("messages");
const input = document.getElementById("input");
const finishBtn = document.getElementById("finishBtn");
  
// ===== UTILS =====
function normalizeText(text){
  return text.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();
}

/* ===== BOT QUEUE + TYPING ===== */
function botSay(text){
  botQueue.push(text);
  if (!botIsTyping) processBotQueue();
}

function processBotQueue(){
  if (botQueue.length === 0) {
    botIsTyping = false;
    return;
  }

  botIsTyping = true;
  const text = botQueue.shift();

  if (typeof text === "function") {
    text();
    processBotQueue();
    return;
  }

  const container = document.createElement("div");
  container.className = "bot-container";

  const avatar = document.createElement("div");
  avatar.className = "bot-avatar";
  avatar.textContent = "ü§ñ";

  const bubble = document.createElement("div");
  bubble.className = "bot thinking";
  bubble.textContent = "r√©fl√©chit";

  container.appendChild(avatar);
  container.appendChild(bubble);
  messages.appendChild(container);
  messages.scrollTop = messages.scrollHeight;

  let dots = 0;
  const thinkingInterval = setInterval(() => {
    dots = (dots + 1) % 4;
    bubble.textContent = "r√©fl√©chit" + ".".repeat(dots);
  }, 400);

  setTimeout(() => {
    clearInterval(thinkingInterval);
    bubble.className = "bot";
    bubble.textContent = "";

    let i = 0;
    const speed = 20;

    const typingInterval = setInterval(() => {
      bubble.textContent += text.charAt(i);
      i++;
      messages.scrollTop = messages.scrollHeight;

      if (i >= text.length) {
        clearInterval(typingInterval);
        processBotQueue();
      }
    }, speed);
  }, 800);
}

function userSay(text){
  const div = document.createElement("div");
  div.className = "user";
  div.textContent = text;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

// ===== THEMES =====
function showThemes(isInitial = false){
  if(isInitial){
    botSay("Bienvenue üëã Choisis une sp√©cialit√© :");
  }
  const wrapper = document.createElement("div");
  wrapper.className = "choices";

  data.themes.forEach(theme=>{
    const btn = document.createElement("button");
    btn.textContent = theme.title;
    btn.onclick = () => selectTheme(theme);
    wrapper.appendChild(btn);
  });

  messages.appendChild(wrapper);
}

function selectTheme(theme){
  document.querySelectorAll(".choices").forEach(e=>e.remove());
  currentChapter = theme.chapters[0];
  questionsAsked.clear();
  botSay(`üìò ${currentChapter.title}`);
  botSay(currentChapter.intro);
  finishBtn.disabled = false;
}

// ===== CHAT =====
function send(){
  if(!currentChapter) return;
  let text = input.value.trim();
  if(!text) return;

  userSay(text);
  input.value = "";

  const normalized = normalizeText(text);
  let matched = false;

  currentChapter.questionSet.forEach(q=>{
    q.patterns.forEach(p=>{
      if(normalized.includes(normalizeText(p))){
        botSay(q.answer);
        questionsAsked.add(q.id);
        matched = true;
      }
    });
  });

  if(!matched) botSay(data.botBehavior.fallbackAnswer);
}

// ===== FIN =====
function calculateScore(){
  if(!currentChapter) return;

  botSay("üìä Fin de la consultation");
  botSay(`Questions abord√©es : ${questionsAsked.size} / ${currentChapter.questionSet.length}`);
  botSay("üìù R√©capitulatif :");
  
  // envoie chaque message du r√©cap s√©par√©ment
  currentChapter.recap.forEach(msg => botSay(msg));

  botSay("‚ú® Consultation termin√©e. Choisis une nouvelle sp√©cialit√© ci-dessous :");

  botQueue.push(() => {
  currentChapter = null;
  questionsAsked.clear();
  finishBtn.disabled = true;
  showThemes();
});
} 

// ===== START =====
showThemes(true);
</script>

</body>
</html>
